<template>
  <section class="section">
    <div class="content">
      <div class="columns">
        <div class="column is-8">
          <h1 class="is-size-1">{{ $t('pages.proposals.title') }}</h1>
          <p>{{ $t('pages.proposals.description') }}</p>
        </div>
        <div class="column is-4 has-text-right">
          <o-button
            variant="primary"
            size="small"
            v-if="isAdmin"
            @click="exportCSV"
          >
            {{ $t('pages.proposals.export') }}
          </o-button>
        </div>
      </div>
      <paginated-table
        classStyle="proposals-list"
        :headers="['ID', 'Title', 'Challenge', 'Budget']"
        :items="proposals"
        :getItems="getProposals"
        :getCount="getCount"
        :itemComponent="ProposalRow"
      >
      </paginated-table>
    </div>
  </section>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { storeToRefs } from 'pinia'
import ProposalRow from '@/components/ProposalRow.vue'
import PaginatedTable from '@/components/PaginatedTable.vue'
import { prepareDataForExport, formatDataForExport } from '@/utils/exportProposals.js'
import downloadCsv from '@/utils/exportCsv.js'
import { useProposals } from '@/store/proposals.js'
const proposalsStore = useProposals()
const { getProposals, getCount, getProposalsForExport, getSomsById } = proposalsStore
const { proposals } = storeToRefs(proposalsStore)

import { useUser } from '@/store/user.js'
const { isAdmin } = useUser()

const exportCSV = async () => {
  const soms = await getProposalsForExport()
  let ids = await getSomsById(soms.map((el) => el.id))
  let data = await prepareDataForExport(soms, ids)
  data = await formatDataForExport(data)
  downloadCsv(data)
}

</script>

<style lang="scss" scoped>
.small-col {
  width: 4rem;
}
</style>
